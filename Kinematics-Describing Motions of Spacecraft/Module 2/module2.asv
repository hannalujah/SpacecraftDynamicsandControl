%% Eigenvalue and eigenvector

A = [-0.87097 0.45161 0.19355;
    -0.19355 -0.67742 0.70968;
    0.45161 0.58065 0.67742];

[V,D] = eig(A);

 %% Addition / Subtraction
BN = [1/3, 2/3, -2/3;
    0, sqrt(2)/2, sqrt(2)/2;
    2*sqrt(2)/3, -sqrt(2)/6, sqrt(2)/6];

FN = [3/4, -1/2, sqrt(3)/4;
    -1/2, 0, sqrt(3)/2;
    -sqrt(3)/4, -2*sqrt(3)/4, -1/4];

BF = BN * transpose(FN);
 

%% DCM rates
BN = A;
w_tilda = [0, -0.3, 0.2;
    0.3, 0, -0.1;
    -0.2, 0.1, 0];
dBN = -1*w_tilda*BN;

%% Euler Angles

dToR = pi/180;
theta1 = 10*dToR;
theta2 = 20*dToR;
theta3 = 30*dToR;

euler321 = M1(theta3)*M2(theta2)*M3(theta1);
C = euler321;

theta1_euler313 = atan2(C(3,1), -C(3,2)) / dToR;
theta2_euler313 = acos(C(3,3)) / dToR;
theta3_euler313 = atan2(C(1,3), C(2,3)) / dToR;

% --- 
% Concept Check 8
% ---

BN_theta1 = 10*dToR;
BN_theta2 = 20*dToR;
BN_theta3 = 30*dToR;

BN_euler321 = M1(BN_theta3)*M2(BN_theta2)*M3(BN_theta1);

RN_theta1 = -5*dToR;
RN_theta2 = 5*dToR;
RN_theta3 = 5*dToR;

RN_euler321 = M1(RN_theta3)*M2(RN_theta2)*M3(RN_theta1);

BR_euler321 = BN_euler321*transpose(RN_euler321);

C = BR_euler321;
BR_theta1 = atan2(C(1,2),C(1,1)) / dToR;
BR_theta2 = -asin(C(1,3)) / dToR;
BR_theta3 = atan2(C(2,3), C(3,3)) / dToR;

%% Concept Check 9
% Integration

t = 0:0.01:60;
psi0 = 40*pi/180;
theta0 = 30*pi/180;
phi0 = 80*pi/180;

EA0 = [psi0; theta0; phi0];
EAi = EA0;
norm = 0;

for i = 1:length(t)
    
    wi = [sin(0.1*i); 0.01; cos(0.1*i)] * 20 * pi/180;
    EAiDiff = diffEA(EAi(2), EAi(3)) * wi;
    EAi = EAiDiff + EAi;
    
    if (i == 42)
        norm = sqrt((EAi(1)^2) + (EAi(2)^2) + (EAi(3)^2))
        break;
    end
end

%% Concept check 9 - Deepseek suggestion
% Simulation parameters
dt = 0.01; % Smaller time step for better accuracy
t_sim = 0:dt:60; % Simulation time from 0 to 60 seconds

% Initial Euler angles in radians
psi0 = 40*pi/180;
theta0 = 30*pi/180;
phi0 = 80*pi/180;

EA = [psi0; theta0; phi0]; % Current Euler angles

% Preallocate for efficiency if needed
% EA_history = zeros(3, length(t_sim));
% EA_history(:,1) = EA;

for i = 1:length(t_sim)
    t = t_sim(i);
    
    % Body angular velocity vector (convert to rad/s)
    w_B = [sin(0.1*t); 0.01; cos(0.1*t)] * 20 * pi/180;
    
    % Get Euler angle rates using kinematic equations
    EA_dot = euler321_kinematic(EA, w_B);
    
    % Integrate using Euler method
    EA = EA + EA_dot * dt;
    
    % Store if needed: EA_history(:,i) = EA;
    
    % Check if we've reached 42 seconds
    if abs(t - 42) < dt/2
        norm_val = sqrt(EA(1)^2 + EA(2)^2 + EA(3)^2);
        fprintf('Euler angle norm at t=42s: %.6f rad\n', norm_val);
        fprintf('Euler angles: ψ=%.6f, θ=%.6f, ϕ=%.6f rad\n', EA(1), EA(2), EA(3));
        break;
    end
end

function EA_dot = euler321_kinematic(EA, w_B)
    % EA = [psi; theta; phi] for 3-2-1 sequence
    % w_B = body angular velocity in body frame
    
    psi = EA(1);
    theta = EA(2);
    phi = EA(3);
    
    % Transformation matrix from body rates to Euler angle rates
    L = [0, sin(phi), cos(phi);
         0, cos(phi)*cos(theta), -sin(phi)*cos(theta);
         cos(theta), sin(phi)*sin(theta), cos(phi)*sin(theta)] / cos(theta);
    
    EA_dot = L * w_B;
end